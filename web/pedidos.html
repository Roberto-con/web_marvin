<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="no-store" http-equiv="Cache-Control">
<title>Pedidos Realizados - Delizia</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
        body {
            background-color: #f7f9fc;
            font-family: 'Segoe UI', sans-serif;
        }
        .container {
            margin-top: 50px;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
        }
        h2 {
            color: #004AAD;
        }
        .table th {
            background-color: #004AAD;
            color: white;
        }
        .table td {
            vertical-align: middle;
        }
    </style>

</meta></head>
<body>
<div class="container">
<h2 class="mb-4 text-center">üì¶ Pedidos Realizados</h2>
<div class="text-end mb-3">
<button class="btn btn-success me-2" onclick="generarReporteMensual()">üìÑ Generar reporte mensual</button>
<button class="btn btn-danger" onclick="limpiarPedidos()">‚ö†Ô∏è Eliminar pedidos</button>
</div>
<div class="row mb-4">
<div class="col-md-4">
<label class="form-label" for="fecha-inicio">Desde:</label>
<input class="form-control" id="fecha-inicio" type="date"/>
</div>
<div class="col-md-4">
<label class="form-label" for="fecha-fin">Hasta:</label>
<input class="form-control" id="fecha-fin" type="date"/>
</div>
<div class="col-md-4 d-flex align-items-end">
<button class="btn btn-primary w-100" onclick="filtrarPedidos()">Filtrar</button>
</div>
</div>
<div class="table-responsive">
<table class="table table-bordered align-middle text-center">
<thead>
<tr>
<th>#</th>
<th>Productos</th>
<th>Total</th>
<th>Cliente</th>
<th>Tel√©fono</th>
<th>Fecha</th>
<th>Acci√≥n</th>
</tr>
</thead>
<tbody id="tabla-pedidos">
</tbody>
</table>
</div>
</div>
<script>
        function generarReporteMensual() {
            fetch("/api/pedidos/reporte", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + localStorage.getItem("token")
                }
            })
            .then(res => {
                if (!res.ok) throw new Error("Error al generar el reporte");
                return res.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = "reporte_pedidos_mes_actual.pdf";
                document.body.appendChild(link);
                link.click();
                link.remove();
            })
            .catch(err => {
                alert("‚ùå No se pudo generar el reporte.");
                console.error(err);
            });
        }
    </script>
<script>
      let pedidosCargados = [];

      function verPedido(index) {
        const pedido = pedidosCargados[index];
        const productos = JSON.parse(pedido.productos_json);

        let html = `
          <p><strong>Cliente:</strong> ${pedido.nombre_cliente || "-"}</p>
          <p><strong>Fecha:</strong> ${new Date(pedido.fecha).toLocaleString()}</p>
          <table class="table table-bordered mt-3">
            <thead>
              <tr>
                <th>Producto</th><th>Sabor</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th>
              </tr>
            </thead>
            <tbody>
              ${productos.map(p => `
                <tr>
                  <td>${p.nombre}</td>
                  <td>${p.sabor || "-"}</td>
                  <td>${p.cantidad}</td>
                  <td>${p.precio.toFixed(2)} Bs</td>
                  <td>${(p.precio * p.cantidad).toFixed(2)} Bs</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
          <p class="text-end"><strong>Total:</strong> ${pedido.total} Bs</p>
        `;

        document.getElementById("detalle-pedido-modal").innerHTML = html;
        new bootstrap.Modal(document.getElementById("modalVerPedido")).show();
      }

      function descargarPedidoPDF() {
        const contenido = document.getElementById("detalle-pedido-modal").innerHTML;
        const win = window.open('', '', 'height=700,width=600');
        win.document.write(`<html><head><title>Pedido</title></head><body>${contenido}</body></html>`);
        win.document.close();
        win.print();
      }

      // Sobrescribir carga de pedidos para guardar en array
      fetch("/api/pedidos", {
        method: "GET",
        headers: {
          "Authorization": "Bearer " + localStorage.getItem("token")
        }
      })
      .then(res => {
        if (!res.ok) throw new Error("Error al obtener los pedidos");
        return res.json();
      })
      .then(pedidos => {
        pedidosCargados = pedidos; // Guardar
        mostrarPedidos(pedidos);   // Reutilizar funci√≥n existente
      })
      .catch(err => {
        document.getElementById("tabla-pedidos").innerHTML = `
          <tr><td colspan="7" class="text-danger text-center">‚ö†Ô∏è No se pudo cargar la lista de pedidos</td></tr>
        `;
        console.error(err);
      });
    </script>
<!-- Modal Ver Pedido -->
<div class="modal fade" id="modalVerPedido" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header bg-primary text-white">
<h5 class="modal-title">Detalles del pedido</h5>
<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body" id="detalle-pedido-modal">
<!-- Se rellena con JS -->
</div>
<div class="modal-footer">
<button class="btn btn-success" onclick="descargarPedidoPDF()">üìÑ Descargar PDF</button>
<button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
</div>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
